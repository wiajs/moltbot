#!/usr/bin/env bun
import { $ } from "bun";
import { join } from "node:path";
import { existsSync } from "node:fs";

// --- 1. è®¾ç½®åŸºç¡€è·¯å¾„ ---
const rootDir = (await $`git rev-parse --show-toplevel`.text()).trim();
const runNodeTool = join(rootDir, "scripts/pre-commit/run-node-tool.js");
const filterFilesScript = join(rootDir, "scripts/pre-commit/filter-staged-files.mjs");

// --- 2. æ£€æŸ¥çŽ¯å¢ƒ ---
if (!existsSync(runNodeTool) || !existsSync(filterFilesScript)) {
  console.error("âŒ Critical: Missing helper scripts in scripts/pre-commit/");
  process.exit(1);
}

// --- 3. èŽ·å–æš‚å­˜åŒºæ–‡ä»¶åˆ—è¡¨ ---
const diffOutput = await $`git diff --cached --name-only --diff-filter=ACMR -z`.quiet().text();
const files = diffOutput.split("\0").filter((f) => f.length > 0);

if (files.length === 0) {
  process.exit(0);
}

// --- 4. è¿‡æ»¤æ–‡ä»¶ ---
const getFilteredFiles = async (mode) => {
  // ä½¿ç”¨ .nothrow() é¿å…å¼‚å¸¸ä¸­æ–­
  const { stdout, exitCode } = await $`bun ${filterFilesScript} ${mode} -- ${files}`.quiet().nothrow();
  if (exitCode !== 0) process.exit(exitCode);
  return stdout.toString().split("\0").filter((f) => f.length > 0);
};

const lintFiles = await getFilteredFiles("lint");
const formatFiles = await getFilteredFiles("format");

// --- 5. æ‰§è¡Œå·¥å…· (å®žçŽ°å‹å¥½è¾“å‡º) ---
if (lintFiles.length > 0) {
  console.log(`ðŸ” Linting ${lintFiles.length} files...`);
  // ä¸ä½¿ç”¨ .quiet()ï¼Œè®©å·¥å…·çš„å½©è‰²è¾“å‡ºç›´æŽ¥æ‰“å°ï¼›ä½¿ç”¨ .nothrow() æ•èŽ·é”™è¯¯
  const { exitCode } = await $`bun ${runNodeTool} oxlint --type-aware --fix -- ${lintFiles}`.nothrow();
  if (exitCode !== 0) process.exit(exitCode); // å‘çŽ°é”™è¯¯æ—¶å¹²å‡€åˆ©è½åœ°é€€å‡º
}

if (formatFiles.length > 0) {
  console.log(`âœ¨ Formatting ${formatFiles.length} files...`);
  const { exitCode } = await $`bun ${runNodeTool} oxfmt --write -- ${formatFiles}`.nothrow();
  if (exitCode !== 0) process.exit(exitCode);
}

// --- 6. é‡æ–°æš‚å­˜ (Re-add) ---
/**
 * è¿‡æ»¤æŽ‰æ‰€æœ‰è·¯å¾„ä¸­åŒ…å« vendor çš„æ–‡ä»¶ã€‚
 * è¿™æ ·å¯ä»¥é˜²æ­¢ git add æŠ¥é”™ï¼Œå› ä¸º Git ä¸å…è®¸å†æ¬¡æ·»åŠ ç¬¦åˆ .gitignore è§„åˆ™çš„å·²è¿½è¸ªæ–‡ä»¶ï¼Œ
 * é™¤éžä½¿ç”¨ -fã€‚é€šè¿‡è¿‡æ»¤æŽ‰å®ƒä»¬ï¼Œæˆ‘ä»¬åªé‡æ–°æš‚å­˜çœŸæ­£è¢« lint/format ä¿®æ”¹è¿‡çš„æºç æ–‡ä»¶ã€‚
 */
const filesToReAdd = files.filter(f => !f.includes("/vendor/") && !f.startsWith("vendor/"));

if (filesToReAdd.length > 0) {
  await $`git add -- ${filesToReAdd}`.nothrow();
}
