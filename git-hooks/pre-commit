#!/usr/bin/env bun
import { $ } from "bun";
import { join } from "node:path";
import { existsSync } from "node:fs";

// 1. è®¾ç½®åŸºç¡€è·¯å¾„
// è·å– Git æ ¹ç›®å½• (å»é™¤æœ«å°¾æ¢è¡Œç¬¦)
const rootDir = (await $`git rev-parse --show-toplevel`.text()).trim();
const runNodeTool = join(rootDir, "scripts/pre-commit/run-node-tool.js");
const filterFilesScript = join(rootDir, "scripts/pre-commit/filter-staged-files.mjs");

// --- 2. æ£€æŸ¥ç¯å¢ƒ ---
if (!existsSync(runNodeTool) || !existsSync(filterFilesScript)) {
  console.error("âŒ Critical: Missing helper scripts in scripts/pre-commit/");
  process.exit(1);
}

// 3. è·å–æš‚å­˜åŒºæ–‡ä»¶åˆ—è¡¨ (æ ¸å¿ƒé€»è¾‘)
// git diff -z è¾“å‡ºä»¥ \0 åˆ†éš”çš„æ–‡ä»¶åï¼Œ.text() è·å–æ–‡æœ¬ï¼Œç„¶åç”¨ split('\0') åˆ†å‰²
const diffOutput = await $`git diff --cached --name-only --diff-filter=ACMR -z`.quiet().text();
// è¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²ï¼ˆå› ä¸º split å¯èƒ½ä¼šåœ¨æœ«å°¾äº§ç”Ÿä¸€ä¸ªç©ºé¡¹ï¼‰
const files = diffOutput.split("\0").filter((f) => f.length > 0);

if (files.length === 0) {
  process.exit(0);
}

// --- 4. è¿‡æ»¤æ–‡ä»¶ (Memory -> Filter Script -> Memory) ---
const getFilteredFiles = async (mode: "lint" | "format") => {
  // ç›´æ¥è°ƒç”¨ bun è¿è¡Œ ts è„šæœ¬
  // è¿™é‡Œçš„ ${files} ä¼šè¢« Bun Shell è‡ªåŠ¨å±•å¼€ä¸ºå¤šä¸ªå‚æ•°ï¼Œéå¸¸å®‰å…¨
  const output = await $`bun ${filterFilesScript} ${mode} -- ${files}`.quiet().text();
  // è§£æ \0 åˆ†éš”çš„è¾“å‡º
  return output.split("\0").filter((f) => f.length > 0);
};

const lintFiles = await getFilteredFiles("lint");
const formatFiles = await getFilteredFiles("format");

// --- 5. æ‰§è¡Œå·¥å…· (Memory -> Runner Script -> Tool) ---
if (lintFiles.length > 0) {
  console.log(`ğŸ” Linting ${lintFiles.length} files...`);
  // è°ƒç”¨ run-node-tool.ts
  await $`bun ${runNodeTool} oxlint --type-aware --fix -- ${lintFiles}`;
}

if (formatFiles.length > 0) {
  console.log(`âœ¨ Formatting ${formatFiles.length} files...`);
  // è°ƒç”¨ run-node-tool.ts
  await $`bun ${runNodeTool} oxfmt --write -- ${formatFiles}`;
}

// --- 6. é‡æ–°æš‚å­˜ (Re-add) ---
// å°†è‡ªåŠ¨ä¿®å¤åçš„å˜æ›´é‡æ–°åŠ å…¥æœ¬æ¬¡æäº¤
await $`git add -- ${files}`;
